<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gán nhãn thủ công - Dental AI</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
  <link href="{{ url_for('static', filename='css/styles.css') }}" rel="stylesheet">
  <style>
    #canvasWrapper { position: relative; border: 1px solid #ccc; }
    canvas { border: 1px solid #999; cursor: crosshair; max-width: 100%; }
    .annotation-item { display: flex; align-items: flex-start; gap: 1rem; padding: 0.5rem; border-bottom: 1px solid #ddd; }
    .color-box { width: 20px; height: 20px; border-radius: 3px; }
  </style>
</head>
<body>
  <div class="wrapper">
    <!-- Sidebar -->
    <nav id="sidebar" class="sidebar">
      <div class="sidebar-header">
        <h3><i class="bi bi-heart-pulse-fill me-2"></i>Dental AI Pro</h3>
      </div>
      <ul class="list-unstyled components">
        <li><a href="/"><i class="bi bi-house-door"></i> Trang chủ</a></li>
        <li><a href="/patients"><i class="bi bi-people"></i> Bệnh nhân</a></li>
        <li><a href="/history"><i class="bi bi-clock-history"></i> Lịch sử</a></li>
        <li class="active"><a href="/labeling"><i class="bi bi-pencil-square"></i> Gán nhãn</a></li>
      </ul>
      <div class="sidebar-footer">
        <a href="/logout" class="btn btn-outline-light btn-sm"><i class="bi bi-box-arrow-right"></i> Đăng xuất</a>
      </div>
    </nav>

    <!-- Page Content -->
    <div id="content" class="content">
      <div class="container py-4">
        <h4>Xem lại kết quả gán nhãn: {{ history.image_name }}</h4>

        {% if segments %}
        <div id="canvasWrapper" class="mb-3">
            <canvas id="viewCanvas"></canvas>
        </div>
        {% else %}
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div id="flash-msg-container" class="position-fixed top-0 start-50 translate-middle-x mt-3 z-3" style="z-index: 9999;">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    </div>
                {% endfor %}
                </div>
            {% endif %}
            {% endwith %}
        {% endif %}
        <a href="/segment" class="btn btn-secondary">Quay lại danh sách</a>
      </div>
    </div>

    <script>
        setTimeout(() => {
          const flash = document.getElementById("flash-msg-container");
          if (flash) {
            flash.remove();
          }
        }, 2000);
      </script>
      
<script>
  const canvas = document.getElementById('viewCanvas');
  const ctx = canvas.getContext('2d');
  const image = new Image();
  const segments = {{ segments | tojson }};  // Dữ liệu vùng phân đoạn từ backend
  
  image.src = "{{ url_for('static', filename='uploads/' + history.image_name) }}";
  image.onload = () => {
    console.log("Ảnh đã load:", image.width, image.height);
    canvas.width = image.width;
    canvas.height = image.height;
    ctx.drawImage(image, 0, 0);
    drawSegments();
  };
  
  image.onerror = () => {
    console.error("Không load được ảnh.");
  };

  function drawSegments() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(image, 0, 0);
    ctx.lineWidth = 2;
  
    segments.forEach((segment, index) => {
      ctx.beginPath();
      ctx.moveTo(segment[0].x, segment[0].y);
      segment.forEach((point) => {
        ctx.lineTo(point.x, point.y);
      });
      ctx.closePath();
      
      ctx.strokeStyle = 'red';
      ctx.stroke();

      // Vẽ nền semi-transparent nếu segment đã hoàn thành
      ctx.fillStyle = 'rgba(255, 0, 0, 0.2)';
      ctx.fill();
      
      // Vẽ nhãn (nếu cần)
      ctx.fillStyle = 'red';
      ctx.font = '16px Arial';
      ctx.fillText(`Segment ${index + 1}`, segment[0].x + 5, segment[0].y + 20);
    });
  }
  
</script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
